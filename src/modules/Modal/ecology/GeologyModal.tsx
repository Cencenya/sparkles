import { Component, createRef } from "react";
import VideoPlayer from "../../Share/Components/VideoPlayer";
// import { config } from "../../Share/skin/ecology/atmosphereConfig";
import { Panel } from "../../../stores/markerModel";
import { Tabs, Carousel, Select, DatePicker } from "antd";
import moment from "moment";
const { TabPane } = Tabs;
const { Option } = Select;
const { RangePicker } = DatePicker;

const dateFormat = "YYYY-MM-DD";
// const css = require("../../../styles/custom.css");
const scss = require("../../../styles/scss/markerBox.scss");
// window.data = {"Code":0,"Data":{"dataDt":[{"id":2,"x":-1.800000,"y":-1.000000,"h":-6.500000,"d2":2.059126,"d3":6.818358,"t":1571155200000},{"id":2,"x":-0.100000,"y":-5.800000,"h":-0.800000,"d2":5.800862,"d3":5.855766,"t":1571162400000},{"id":2,"x":-4.500000,"y":-5.900000,"h":-7.300000,"d2":7.420243,"d3":10.409131,"t":1571169600000},{"id":2,"x":-1.200000,"y":-2.400000,"h":-8.300000,"d2":2.683282,"d3":8.722958,"t":1571176800000},{"id":2,"x":-1.800000,"y":-3.600000,"h":8.000000,"d2":4.024922,"d3":8.955445,"t":1571184000000},{"id":2,"x":-5.100000,"y":-5.400000,"h":-11.500000,"d2":7.427651,"d3":13.690142,"t":1571191200000},{"id":2,"x":-4.100000,"y":-6.300000,"h":-3.000000,"d2":7.516648,"d3":8.093207,"t":1571198400000},{"id":2,"x":1.200000,"y":-6.800000,"h":-9.100000,"d2":6.905071,"d3":11.423222,"t":1571205600000},{"id":2,"x":-4.100000,"y":-6.200000,"h":2.700000,"d2":7.433034,"d3":7.908224,"t":1571212800000},{"id":2,"x":-2.100000,"y":-2.100000,"h":1.600000,"d2":2.969848,"d3":3.373426,"t":1571220000000},{"id":2,"x":-5.200000,"y":-2.500000,"h":-2.500000,"d2":5.769749,"d3":6.288084,"t":1571227200000},{"id":2,"x":-0.800000,"y":-4.000000,"h":-6.800000,"d2":4.079216,"d3":7.929691,"t":1571234400000},{"id":2,"x":-1.500000,"y":-0.900000,"h":-8.400000,"d2":1.749286,"d3":8.580210,"t":1571241600000},{"id":2,"x":-0.600000,"y":-6.500000,"h":-2.300000,"d2":6.527634,"d3":6.920983,"t":1571248800000},{"id":2,"x":-3.600000,"y":-5.100000,"h":-8.700000,"d2":6.242596,"d3":10.707941,"t":1571256000000},{"id":2,"x":-3.900000,"y":-0.300000,"h":4.800000,"d2":3.911521,"d3":6.191930,"t":1571263200000},{"id":2,"x":-2.000000,"y":-3.700000,"h":6.700000,"d2":4.205948,"d3":7.910752,"t":1571270400000},{"id":2,"x":-4.000000,"y":-5.100000,"h":-17.100000,"d2":6.481512,"d3":18.287154,"t":1571277600000},{"id":2,"x":-2.300000,"y":-6.600000,"h":-5.600000,"d2":6.989278,"d3":8.956004,"t":1571284800000},{"id":2,"x":1.500000,"y":-6.000000,"h":-8.100000,"d2":6.184658,"d3":10.191173,"t":1571292000000},{"id":2,"x":-2.200000,"y":-5.500000,"h":5.000000,"d2":5.923681,"d3":7.751774,"t":1571299200000},{"id":2,"x":-2.300000,"y":-3.400000,"h":1.600000,"d2":4.104875,"d3":4.405678,"t":1571306400000},{"id":2,"x":-5.000000,"y":-4.400000,"h":-5.000000,"d2":6.660330,"d3":8.328265,"t":1571313600000},{"id":2,"x":-0.600000,"y":-4.000000,"h":-3.500000,"d2":4.044750,"d3":5.348832,"t":1571320800000},{"id":2,"x":-2.200000,"y":-2.000000,"h":-3.000000,"d2":2.973214,"d3":4.223742,"t":1571328000000},{"id":2,"x":-2.900000,"y":-6.700000,"h":-1.400000,"d2":7.300685,"d3":7.433707,"t":1571335200000},{"id":2,"x":-2.300000,"y":-5.200000,"h":-11.200000,"d2":5.685948,"d3":12.560653,"t":1571342400000},{"id":2,"x":-4.600000,"y":0.100000,"h":3.600000,"d2":4.601087,"d3":5.842089,"t":1571349600000},{"id":2,"x":-2.500000,"y":-4.700000,"h":2.500000,"d2":5.323533,"d3":5.881326,"t":1571356800000},{"id":2,"x":-3.900000,"y":-4.700000,"h":-16.100000,"d2":6.107373,"d3":17.219466,"t":1571364000000},{"id":2,"x":-3.300000,"y":-5.700000,"h":-3.600000,"d2":6.586350,"d3":7.505998,"t":1571371200000},{"id":2,"x":0.700000,"y":-7.200000,"h":-8.600000,"d2":7.233948,"d3":11.237882,"t":1571378400000},{"id":2,"x":-1.600000,"y":-5.200000,"h":2.800000,"d2":5.440588,"d3":6.118823,"t":1571385600000},{"id":2,"x":-2.100000,"y":-4.100000,"h":-0.100000,"d2":4.606517,"d3":4.607602,"t":1571392800000},{"id":2,"x":-4.800000,"y":-4.100000,"h":-4.800000,"d2":6.312686,"d3":7.930322,"t":1571400000000},{"id":2,"x":-0.600000,"y":-4.300000,"h":-4.300000,"d2":4.341659,"d3":6.110646,"t":1571407200000},{"id":2,"x":-1.200000,"y":-2.300000,"h":-7.300000,"d2":2.594224,"d3":7.747258,"t":1571414400000},{"id":2,"x":-2.500000,"y":-4.400000,"h":-11.000000,"d2":5.060632,"d3":12.108262,"t":1571428800000},{"id":2,"x":-3.200000,"y":-3.300000,"h":-4.700000,"d2":4.596738,"d3":6.574192,"t":1571436000000},{"id":2,"x":-1.800000,"y":-3.800000,"h":5.200000,"d2":4.204759,"d3":6.687301,"t":1571443200000},{"id":2,"x":-4.200000,"y":-4.200000,"h":-16.500000,"d2":5.939697,"d3":17.536533,"t":1571450400000},{"id":2,"x":-3.100000,"y":-4.100000,"h":-5.000000,"d2":5.140039,"d3":7.170774,"t":1571457600000},{"id":2,"x":1.800000,"y":-5.500000,"h":-6.100000,"d2":5.787055,"d3":8.408329,"t":1571464800000},{"id":2,"x":-2.700000,"y":-5.200000,"h":3.900000,"d2":5.859181,"d3":7.038466,"t":1571472000000},{"id":2,"x":-3.700000,"y":-2.500000,"h":1.800000,"d2":4.465423,"d3":4.814561,"t":1571479200000},{"id":2,"x":-1.700000,"y":-5.000000,"h":-3.300000,"d2":5.281098,"d3":6.227359,"t":1571493600000},{"id":2,"x":-2.400000,"y":-5.000000,"h":-10.200000,"d2":5.546170,"d3":11.610340,"t":1571515200000},{"id":2,"x":-3.500000,"y":-0.400000,"h":1.100000,"d2":3.522783,"d3":3.690528,"t":1571522400000},{"id":2,"x":-4.400000,"y":-2.900000,"h":-0.200000,"d2":5.269725,"d3":5.273519,"t":1571529600000},{"id":2,"x":-6.100000,"y":-5.200000,"h":-4.800000,"d2":8.015610,"d3":9.342912,"t":1571536800000},{"id":2,"x":-2.800000,"y":-6.300000,"h":-8.500000,"d2":6.894200,"d3":10.944405,"t":1571544000000},{"id":2,"x":-0.200000,"y":-4.400000,"h":-2.300000,"d2":4.404543,"d3":4.968903,"t":1571551200000},{"id":2,"x":-5.200000,"y":-4.300000,"h":-4.700000,"d2":6.747592,"d3":8.223138,"t":1571572800000},{"id":2,"x":-0.400000,"y":-5.000000,"h":-4.900000,"d2":5.015974,"d3":7.012132,"t":1571580000000},{"id":2,"x":-4.900000,"y":-1.900000,"h":6.400000,"d2":5.255473,"d3":8.281304,"t":1571616000000},{"id":2,"x":-6.100000,"y":-5.700000,"h":-0.300000,"d2":8.348653,"d3":8.354041,"t":1571623200000},{"id":2,"x":-3.700000,"y":-7.000000,"h":-5.700000,"d2":7.917702,"d3":9.756024,"t":1571630400000},{"id":2,"x":-1.300000,"y":-4.400000,"h":-3.600000,"d2":4.588028,"d3":5.831809,"t":1571637600000},{"id":2,"x":-2.000000,"y":-3.500000,"h":0.900000,"d2":4.031129,"d3":4.130375,"t":1571644800000},{"id":2,"x":-3.300000,"y":-4.200000,"h":1.600000,"d2":5.341348,"d3":5.575841,"t":1571652000000},{"id":2,"x":-4.900000,"y":-4.100000,"h":-2.400000,"d2":6.389053,"d3":6.824954,"t":1571659200000},{"id":2,"x":-1.600000,"y":-4.800000,"h":-4.000000,"d2":5.059644,"d3":6.449806,"t":1571666400000},{"id":2,"x":1.600000,"y":-2.800000,"h":-4.100000,"d2":3.224903,"d3":5.216321,"t":1571673600000},{"id":2,"x":-1.300000,"y":-6.300000,"h":-2.100000,"d2":6.432729,"d3":6.766831,"t":1571680800000},{"id":2,"x":-3.000000,"y":-4.400000,"h":-7.200000,"d2":5.325411,"d3":8.955445,"t":1571688000000},{"id":2,"x":-2.500000,"y":-0.200000,"h":1.500000,"d2":2.507987,"d3":2.922328,"t":1571695200000},{"id":2,"x":-4.000000,"y":-4.500000,"h":1.200000,"d2":6.020797,"d3":6.139218,"t":1571702400000},{"id":2,"x":-3.700000,"y":-6.900000,"h":-3.500000,"d2":7.829432,"d3":8.576130,"t":1571709600000},{"id":2,"x":-5.400000,"y":-7.300000,"h":-3.400000,"d2":9.080198,"d3":9.695875,"t":1571716800000},{"id":2,"x":-2.700000,"y":-5.100000,"h":1.900000,"d2":5.770615,"d3":6.075360,"t":1571724000000},{"id":2,"x":-1.700000,"y":-3.000000,"h":3.900000,"d2":3.448188,"d3":5.205766,"t":1571731200000},{"id":2,"x":-3.100000,"y":-2.900000,"h":-0.200000,"d2":4.244997,"d3":4.249706,"t":1571738400000},{"id":2,"x":-4.600000,"y":-3.100000,"h":-2.000000,"d2":5.547071,"d3":5.896609,"t":1571745600000},{"id":2,"x":-0.100000,"y":-5.900000,"h":-4.900000,"d2":5.900847,"d3":7.670072,"t":1571752800000},{"id":2,"x":2.000000,"y":-3.400000,"h":-4.400000,"d2":3.944617,"d3":5.909315,"t":1571760000000},{"id":2,"x":-1.800000,"y":-6.400000,"h":-2.100000,"d2":6.648308,"d3":6.972087,"t":1571767200000},{"id":2,"x":-2.800000,"y":-3.900000,"h":-7.400000,"d2":4.801042,"d3":8.820998,"t":1571774400000},{"id":2,"x":-1.500000,"y":0.200000,"h":2.400000,"d2":1.513275,"d3":2.837252,"t":1571781600000},{"id":2,"x":-4.900000,"y":-3.000000,"h":1.400000,"d2":5.745433,"d3":5.913544,"t":1571788800000}],"warnsDt":[{"id":"X轴位移","alertTypeId":"1","v":null},{"id":"Y轴位移","alertTypeId":"1","v":null},{"id":"H轴位移","alertTypeId":"1","v":null}]}}

let chartTabs = [
  {
    name: "表面位移监测",
    chartUrl: `${process.env.publicPath}chart/displacementtrend.html`,
    children: [
      { name: "位移变化趋势图" },
      { name: "断面曲线图" },
      { name: "速度" },
      { name: "加速度" }
    ]
  },
  {
    name: "内部位移监测",
    chartUrl: `${process.env.publicPath}chart/nbwy.html`,
    children: [{ name: "挠度曲线图" }, { name: "变化过程线" }]
  },
  {
    name: "雨量监测",
    chartUrl: `${process.env.publicPath}chart/rain.html`,
    children: [{ name: "日/月降雨量" }]
  },
  {
    name: "水位监测",
    chartUrl: `${process.env.publicPath}chart/hydrograph.html?monitortype=nw`,
    children: [{ name: "变化变化过程曲线" }]
  }
];

interface Props {
  address: string;
  cancel?: (e?) => void;
  tabs: [Panel] | null;
}

interface States {
  lang: object | null;
}
export default class GeologyModal extends Component<Props, States> {
  videoRef = createRef();
  slider = createRef();
  constructor(props: Props) {
    super(props);
    this.state = {
      lang: null
    };
  }

  componentWillMount() {
    fetch(`${process.env.publicPath}chart/lang.json`)
      .then(r => r.json())
      .then(r => ((window.lang = r), this.setState({ lang: r })))
      .catch(console.table);
  }
  componentDidMount() {
    setInterval(() => {
      this.setState({ _time: moment(new Date()).format("HH:mm:ss") });
    }, 1000);
  }
  query = (i: number | string) => {
    let timer = setInterval(() => {
      let dom = document.querySelector(`#tabs_${i}_iframe`);
      if (
        dom &&
        (dom as HTMLIFrameElement).contentWindow &&
        dom.contentWindow["doQuery"]
      ) {
        dom.contentWindow["doQuery"]();
        clearInterval(timer);
      }
    }, 20);
  };
  changeTab = key => {};
  componentWillUnmount() {
    if (this.videoRef.current && this.videoRef.current.player.hasStarted()) {
      this.videoRef.current.player.pause();
    }
  }
  render() {
    const { address, tabs } = this.props;
    let style = {};
    const hasMonitor = tabs.find(item => item.type == "monitor");
    if (!hasMonitor) {
      Object.assign(style, { gridTemplateColumns: "100%" });
    }
    return (
      <div className={scss["grid"]} style={style}>
        <div>
          <table style={{ marginBottom: "12px" }}>
            <tbody>
              <tr>
                <td>监测类型</td>
                <td>{window.currentMenu.title}</td>
                <td>位置</td>
                <td>{address}</td>
              </tr>
            </tbody>
          </table>
          <Tabs onChange={this.changeTab} animated={false}>
            {chartTabs.map((item, i) => (
              <TabPane tab={item.name} key={i + ""} style={{}}>
                <>
                  <div
                    className={
                      scss["flex-center-between"] + " " + scss["chartBar"]
                    }
                    style={{
                      backgroundColor: "#828282",
                      padding: "8px",
                      marginBottom: "12px"
                    }}
                  >
                    <div>
                      <Select
                        defaultValue={item.children[0].name}
                        onChange={val => {}}
                      >
                        {item.children.map((item, i) => (
                          <Option key={i} value={item.name}>
                            {item.name}
                          </Option>
                        ))}
                      </Select>
                    </div>
                    <div className={""}>
                      <label>数据类型:</label>
                      <Select defaultValue="实时数据">
                        <Option key={1} value={"实时数据"}>
                          实时数据
                        </Option>
                      </Select>
                      <label>监测时间:</label>
                      <RangePicker
                        defaultValue={[moment().subtract("days", 7), moment()]}
                        format={dateFormat}
                      />
                    </div>
                  </div>
                  {this.state.lang && (
                    <iframe
                      id={`tabs_${i}_iframe`}
                      name={`tabs_${i}_iframe`}
                      src={item.chartUrl}
                      frameBorder="0"
                      // frameSpacing="0"
                      marginHeight={0}
                      marginWidth={0}
                      style={{
                        width: "100%",
                        height: "400px",
                        background: "white"
                      }}
                    />
                  )}
                </>
              </TabPane>
            ))}
          </Tabs>
        </div>
        {hasMonitor ? (
          <div
            style={{
              display: "grid",
              // gridTemplateRows: "5fr 3fr",
              height: "100%"
            }}
          >
            <div style={{ minWidth: "200px" }}>
              <Carousel
                dots={false}
                infinite={true}
                speed={500}
                arrows={true}
                slidesToShow={1}
                swipeToSlide={true}
                slidesToScroll={1}
                prevArrow={<img src={"./images/ecology/icon_arrowleft.png"} />}
                nextArrow={<img src={"./images/ecology/icon_arrowright.png"} />}
              >
                {tabs
                  .filter(item => item.type == "monitor")
                  .map((item, i) => (
                    <div key={i}>
                      <VideoPlayer
                        sources={[{ src: item.str! }]}
                        triggerRef={ref => (this.videoRef.current = ref)}
                        style={{ height: "100%", width: "100%" }}
                      />
                    </div>
                  ))}
              </Carousel>
            </div>
          </div>
        ) : null}
      </div>
    );
  }
}
